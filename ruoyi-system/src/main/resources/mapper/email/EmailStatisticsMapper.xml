<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.email.EmailStatisticsMapper">
    
    <resultMap type="EmailStatistics" id="EmailStatisticsResult">
        <result property="statId"    column="stat_id"    />
        <result property="statDate"    column="stat_date"    />
        <result property="statType"    column="stat_type"    />
        <result property="totalSent"    column="total_sent"    />
        <result property="totalDelivered"    column="total_delivered"    />
        <result property="totalOpened"    column="total_opened"    />
        <result property="totalReplied"    column="total_replied"    />
        <result property="deliveryRate"    column="delivery_rate"    />
        <result property="openRate"    column="open_rate"    />
        <result property="replyRate"    column="reply_rate"    />
        <result property="messageId"    column="message_id"    />
        <result property="status"    column="status"    />
        <result property="deliveredTime"    column="delivered_time"    />
        <result property="openedTime"    column="opened_time"    />
        <result property="repliedTime"    column="replied_time"    />
        <result property="clickedTime"    column="clicked_time"    />
        <result property="accountId"    column="account_id"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="selectEmailStatisticsVo">
        select stat_id, stat_date, stat_type, total_sent, total_delivered, total_opened, total_replied, delivery_rate, open_rate, reply_rate, message_id, status, delivered_time, opened_time, replied_time, clicked_time, account_id, create_time, update_time from email_statistics
    </sql>

    <select id="selectEmailStatisticsList" parameterType="EmailStatistics" resultMap="EmailStatisticsResult">
        <include refid="selectEmailStatisticsVo"/>
        <where>  
            <if test="statDate != null "> and stat_date = #{statDate}</if>
            <if test="statType != null  and statType != ''"> and stat_type = #{statType}</if>
            <if test="params.beginTime != null and params.beginTime != ''"><!-- 开始时间检索 -->
                and date_format(create_time,'%y%m%d') &gt;= date_format(#{params.beginTime},'%y%m%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''"><!-- 结束时间检索 -->
                and date_format(create_time,'%y%m%d') &lt;= date_format(#{params.endTime},'%y%m%d')
            </if>
        </where>
        order by stat_date desc, stat_type asc
    </select>
    
    <select id="selectEmailStatisticsByStatId" parameterType="Long" resultMap="EmailStatisticsResult">
        <include refid="selectEmailStatisticsVo"/>
        where stat_id = #{statId}
    </select>

    <select id="selectEmailStatisticsByMessageId" parameterType="String" resultMap="EmailStatisticsResult">
        <include refid="selectEmailStatisticsVo"/>
        where message_id = #{messageId}
    </select>
        
    <insert id="insertEmailStatistics" parameterType="EmailStatistics" useGeneratedKeys="true" keyProperty="statId">
        insert into email_statistics
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="statDate != null">stat_date,</if>
            <if test="statType != null">stat_type,</if>
            <if test="totalSent != null">total_sent,</if>
            <if test="totalDelivered != null">total_delivered,</if>
            <if test="totalOpened != null">total_opened,</if>
            <if test="totalReplied != null">total_replied,</if>
            <if test="deliveryRate != null">delivery_rate,</if>
            <if test="openRate != null">open_rate,</if>
            <if test="replyRate != null">reply_rate,</if>
            <if test="messageId != null and messageId != ''">message_id,</if>
            <if test="status != null and status != ''">status,</if>
            <if test="deliveredTime != null">delivered_time,</if>
            <if test="openedTime != null">opened_time,</if>
            <if test="repliedTime != null">replied_time,</if>
            <if test="clickedTime != null">clicked_time,</if>
            <if test="accountId != null">account_id,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="statDate != null">#{statDate},</if>
            <if test="statType != null">#{statType},</if>
            <if test="totalSent != null">#{totalSent},</if>
            <if test="totalDelivered != null">#{totalDelivered},</if>
            <if test="totalOpened != null">#{totalOpened},</if>
            <if test="totalReplied != null">#{totalReplied},</if>
            <if test="deliveryRate != null">#{deliveryRate},</if>
            <if test="openRate != null">#{openRate},</if>
            <if test="replyRate != null">#{replyRate},</if>
            <if test="messageId != null and messageId != ''">#{messageId},</if>
            <if test="status != null and status != ''">#{status},</if>
            <if test="deliveredTime != null">#{deliveredTime},</if>
            <if test="openedTime != null">#{openedTime},</if>
            <if test="repliedTime != null">#{repliedTime},</if>
            <if test="clickedTime != null">#{clickedTime},</if>
            <if test="accountId != null">#{accountId},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
         </trim>
    </insert>

    <update id="updateEmailStatistics" parameterType="EmailStatistics">
        update email_statistics
        <trim prefix="SET" suffixOverrides=",">
            <if test="statDate != null">stat_date = #{statDate},</if>
            <if test="statType != null">stat_type = #{statType},</if>
            <if test="totalSent != null">total_sent = #{totalSent},</if>
            <if test="totalDelivered != null">total_delivered = #{totalDelivered},</if>
            <if test="totalOpened != null">total_opened = #{totalOpened},</if>
            <if test="totalReplied != null">total_replied = #{totalReplied},</if>
            <if test="deliveryRate != null">delivery_rate = #{deliveryRate},</if>
            <if test="openRate != null">open_rate = #{openRate},</if>
            <if test="replyRate != null">reply_rate = #{replyRate},</if>
            <if test="messageId != null and messageId != ''">message_id = #{messageId},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="deliveredTime != null">delivered_time = #{deliveredTime},</if>
            <if test="openedTime != null">opened_time = #{openedTime},</if>
            <if test="repliedTime != null">replied_time = #{repliedTime},</if>
            <if test="clickedTime != null">clicked_time = #{clickedTime},</if>
            <if test="accountId != null">account_id = #{accountId},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where stat_id = #{statId}
    </update>

    <delete id="deleteEmailStatisticsByStatId" parameterType="Long">
        delete from email_statistics where stat_id = #{statId}
    </delete>

    <delete id="deleteEmailStatisticsByStatIds" parameterType="String">
        delete from email_statistics where stat_id in 
        <foreach item="statId" collection="array" open="(" separator="," close=")">
            #{statId}
        </foreach>
    </delete>

    <!-- 生成每日统计 -->
    <insert id="generateDailyStatistics" parameterType="String">
        INSERT INTO email_statistics (stat_date, stat_type, total_sent, total_delivered, total_opened, total_replied, delivery_rate, open_rate, reply_rate, create_time)
        SELECT 
            #{statDate} as stat_date,
            '1' as stat_type,
            COUNT(*) as total_sent,
            COUNT(CASE WHEN status >= '2' THEN 1 END) as total_delivered,
            COUNT(CASE WHEN status >= '3' THEN 1 END) as total_opened,
            COUNT(CASE WHEN status >= '4' THEN 1 END) as total_replied,
            ROUND(COUNT(CASE WHEN status >= '2' THEN 1 END) * 100.0 / COUNT(*), 2) as delivery_rate,
            ROUND(COUNT(CASE WHEN status >= '3' THEN 1 END) * 100.0 / COUNT(*), 2) as open_rate,
            ROUND(COUNT(CASE WHEN status >= '4' THEN 1 END) * 100.0 / COUNT(*), 2) as reply_rate,
            NOW() as create_time
        FROM email_send_record 
        WHERE DATE(send_time) = #{statDate}
        ON DUPLICATE KEY UPDATE
            total_sent = VALUES(total_sent),
            total_delivered = VALUES(total_delivered),
            total_opened = VALUES(total_opened),
            total_replied = VALUES(total_replied),
            delivery_rate = VALUES(delivery_rate),
            open_rate = VALUES(open_rate),
            reply_rate = VALUES(reply_rate),
            update_time = NOW()
    </insert>

    <!-- 生成月度统计 -->
    <insert id="generateMonthlyStatistics" parameterType="String">
        INSERT INTO email_statistics (stat_date, stat_type, total_sent, total_delivered, total_opened, total_replied, delivery_rate, open_rate, reply_rate, create_time)
        SELECT 
            CONCAT(#{yearMonth}, '-01') as stat_date,
            '2' as stat_type,
            COUNT(*) as total_sent,
            COUNT(CASE WHEN status >= '2' THEN 1 END) as total_delivered,
            COUNT(CASE WHEN status >= '3' THEN 1 END) as total_opened,
            COUNT(CASE WHEN status >= '4' THEN 1 END) as total_replied,
            ROUND(COUNT(CASE WHEN status >= '2' THEN 1 END) * 100.0 / COUNT(*), 2) as delivery_rate,
            ROUND(COUNT(CASE WHEN status >= '3' THEN 1 END) * 100.0 / COUNT(*), 2) as open_rate,
            ROUND(COUNT(CASE WHEN status >= '4' THEN 1 END) * 100.0 / COUNT(*), 2) as reply_rate,
            NOW() as create_time
        FROM email_send_record 
        WHERE DATE_FORMAT(send_time, '%Y-%m') = #{yearMonth}
        ON DUPLICATE KEY UPDATE
            total_sent = VALUES(total_sent),
            total_delivered = VALUES(total_delivered),
            total_opened = VALUES(total_opened),
            total_replied = VALUES(total_replied),
            delivery_rate = VALUES(delivery_rate),
            open_rate = VALUES(open_rate),
            reply_rate = VALUES(reply_rate),
            update_time = NOW()
    </insert>

    <!-- 生成年度统计 -->
    <insert id="generateYearlyStatistics" parameterType="String">
        INSERT INTO email_statistics (stat_date, stat_type, total_sent, total_delivered, total_opened, total_replied, delivery_rate, open_rate, reply_rate, create_time)
        SELECT 
            CONCAT(#{year}, '-01-01') as stat_date,
            '3' as stat_type,
            COUNT(*) as total_sent,
            COUNT(CASE WHEN status >= '2' THEN 1 END) as total_delivered,
            COUNT(CASE WHEN status >= '3' THEN 1 END) as total_opened,
            COUNT(CASE WHEN status >= '4' THEN 1 END) as total_replied,
            ROUND(COUNT(CASE WHEN status >= '2' THEN 1 END) * 100.0 / COUNT(*), 2) as delivery_rate,
            ROUND(COUNT(CASE WHEN status >= '3' THEN 1 END) * 100.0 / COUNT(*), 2) as open_rate,
            ROUND(COUNT(CASE WHEN status >= '4' THEN 1 END) * 100.0 / COUNT(*), 2) as reply_rate,
            NOW() as create_time
        FROM email_send_record 
        WHERE YEAR(send_time) = #{year}
        ON DUPLICATE KEY UPDATE
            total_sent = VALUES(total_sent),
            total_delivered = VALUES(total_delivered),
            total_opened = VALUES(total_opened),
            total_replied = VALUES(total_replied),
            delivery_rate = VALUES(delivery_rate),
            open_rate = VALUES(open_rate),
            reply_rate = VALUES(reply_rate),
            update_time = NOW()
    </insert>

</mapper>
